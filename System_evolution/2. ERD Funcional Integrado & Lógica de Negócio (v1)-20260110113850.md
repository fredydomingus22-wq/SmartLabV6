# 2. ERD Funcional Integrado & Lógica de Negócio (v1)

# 2\. ERD Funcional Integrado & Lógica de Negócio (v1)

> Esta página aprofunda o Private ([https://app.clickup.com/90121432851/docs/2kxufvrk-752/2kxufvrk-792](https://app.clickup.com/90121432851/docs/2kxufvrk-752/2kxufvrk-792)) e o capítulo **System Foundation**, transformando o modelo conceitual em **ERD funcional** com foco em regras de negócio industriais, estados e integrações MES ↔ LIMS ↔ QMS ↔ FSMS, incluindo CIPs, gestão de equipamentos e metrologia.
* * *

## 2.1 Objetivo do ERD funcional

*   Traduzir a visão global em **domínios funcionais claros**, alinhados a **ISO 9001, ISO 22000, ISO 17025 e HACCP**.
*   Explicitar **entidades, relações e estados** que interessam diretamente a:
    *   decisão de **liberação/bloqueio de lote**;
    *   comprovação em **auditorias**;
    *   desenho de **tabelas e serviços de backend** (entrada para o TAI-AI).
*   Servir de referência única para:
    *   desenho físico da base de dados (Supabase);
    *   desenho de APIs/serviços em TypeScript (Next.js);
    *   documentação de fluxos no System Foundation.
* * *

## 2.2 Núcleo transversal de domínio

### 2.2.1 Entidades centrais

*   **Tenant / Organização** (implícito em todas as entidades)
*   **UnidadeIndustrial** (fábrica)
*   **LinhaProducao**
*   **EquipamentoProcesso** (tanques, enchedoras, pasteurizadores, CIP skids, etc.)
*   **Produto** / **VersaoProduto**
*   **Receita** / **Formulação**
*   **EspecificacaoProduto**
*   **ParametroControle** (ligação Engenharia de Produto ↔ LIMS ↔ FSMS)
*   **Fornecedor**
*   **MateriaPrima / MaterialEmbalagem**
*   **LoteMateriaPrima**
*   **OrdemProducao**
*   **LoteProducao**
*   **Turno**
*   **PlanoHACCP**, **PCC**, **MonitorizacaoPCC**
*   **PlanoAmostragem**, **Amostra**, **EnsaioLaboratorial**, **ResultadoEnsaio**, **Laudo**
*   **NaoConformidade**, **CAPA**, **Auditoria**
*   **EquipamentoLaboratorio**, **CertificadoCalibracao**, **IntervencaoManutencao**
*   **ExecucaoCIP**, **CircuitoCIP**, **PontoCIP**
*   **Usuario**, **PerfilAcesso**, **Permissao**, **AuditLog**

### 2.2.2 Relações globais (resumo)

*   Uma **UnidadeIndustrial** possui várias **LinhaProducao** e vários **EquipamentoProcesso**.
*   Um **Produto** referencia **Receita**, **EspecificacaoProduto** e **PlanoHACCP** aplicável.
*   Uma **OrdemProducao** gera um ou mais **LoteProducao**.
*   Cada **LoteProducao**:
    *   é produzido numa **LinhaProducao** e **Turno**;
    *   consome vários **LoteMateriaPrima** (por **Fornecedor**);
    *   utiliza um conjunto de **EquipamentoProcesso** (via eventos de produção);
    *   está ligado a **MonitorizacaoPCC**, **Amostra/ResultadoEnsaio/Laudo** e eventuais **NaoConformidade**.
*   **PlanoHACCP** → vários **PCC** → vários **MonitorizacaoPCC**.
*   **PlanoAmostragem** → várias **Amostra** → vários **EnsaioLaboratorial** → **ResultadoEnsaio** → **Laudo**.
*   **ResultadoEnsaio**, **MonitorizacaoPCC**, **ExecucaoCIP** reprovada e **problemas metrológicos** podem originar **NaoConformidade** + **CAPA**.
* * *

## 2.3 Domínio Produção (MES) e sua ligação à Qualidade

### 2.3.1 Entidades e estados principais

*   **OrdemProducao**
    *   Estados: `Planeada`, `EmExecucao`, `Concluida`, `Cancelada`.
*   **LoteProducao**
    *   Estados de execução: `EmExecucao`, `Concluida`.
    *   Estados de qualidade: `AguardandoLiberacaoQualidade`, `Liberado`, `Bloqueado`, `Segregado`, (opcional futuro: `LiberadoCondicional`).
*   **EventoProducao** (paragens, retomadas, sucata, ajustes)
*   **ConsumoLoteMateriaPrima** (tabela de junção LoteProducao ↔ LoteMateriaPrima)

### 2.3.2 Regras de negócio chave

1. **Abertura de LoteProducao**
    *   A partir de **OrdemProducao(Planeada)** cria **LoteProducao(EmExecucao)**.
    *   Gatilhos backend:
        *   verificar existência de **PlanoHACCP** e **PlanoAmostragem** ativos para produto/linha;
        *   criar "ganchos" de integração para geração de **Amostra** no LIMS.
2. **Encerramento de LoteProducao**
    *   Ao concluir produção física, estado de execução → `Concluida` e estado de qualidade → `AguardandoLiberacaoQualidade`.
    *   Motor de decisão de qualidade (ver 2.7) avalia:
        *   **ResultadoEnsaio** obrigatórios;
        *   **MonitorizacaoPCC** críticos;
        *   **NC** abertas para lote/matérias-primas;
        *   situação de **CIP** dos **EquipamentoProcesso** usados.
3. **Liberação/Bloqueio de lote**
    *   Transições permitidas de estado de qualidade:
        *   `AguardandoLiberacaoQualidade` → `Liberado` (todas as condições OK).
        *   `AguardandoLiberacaoQualidade` → `Bloqueado` / `Segregado` (desvios críticos).
    *   Apenas **Técnico de Qualidade / Responsável de Segurança Alimentar** podem alterar estado para `Liberado` (registo em **AuditLog**).

Normas relevantes: **ISO 9001**, **ISO 22000**, **HACCP**.
* * *

## 2.4 Domínio Laboratório (LIMS) + Metrologia (ISO 17025)

### 2.4.1 Entidades LIMS

*   **PlanoAmostragem**: por produto/linha/PCC/tipo de amostra.
*   **Amostra**: origem (processo, produto acabado, matéria-prima, ambiente, água, superfície), referência a **LoteProducao** ou **LoteMateriaPrima**.
    *   Estados: `AguardandoColeta`, `EmAnalise`, `Concluida`, `Cancelada`.
*   **EnsaioLaboratorial**: método, norma, tempo, tipo (micro/físico‑químico).
*   **ResultadoEnsaio**: valor, unidade, limite (ligado a **ParametroControle/EspecificacaoProduto**), `conformidade` (Aprovado, Reprovado), criticidade.
*   **Laudo**: consolida resultados por lote; estado (Rascunho, Emitido, Anulado).

### 2.4.2 Entidades de metrologia

*   **EquipamentoLaboratorio**: código interno, n.º série, localização, faixa, incerteza.
    *   `EstadoMetrologico`: `Apto`, `EmCalibracao`, `Reprovado`, `ForaDeServico`.
*   **CertificadoCalibracao**: datas, resultados, laboratório emissor.
*   **IntervencaoManutencao**: corretiva/preventiva, impacto em calibração.

### 2.4.3 Regras de negócio chave

1. **Geração automática de Amostras**
    *   Eventos MES (abertura/fecho de LoteProducao, produção de X toneladas, etc.) + **PlanoAmostragem** geram **Amostra**.
2. **Validação de Resultados**
    *   **ResultadoEnsaio** sempre referencia **EspecificacaoProduto/ParametroControle** vigente.
    *   Estados:
        *   `Provisorio` → `ValidadoLaboratorio` → `ValidadoQualidade`.
    *   Resultado fora de especificação **obriga** classificação de criticidade e pode:
        *   originar **NaoConformidade**;
        *   propor bloqueio de **LoteProducao**.
3. **Regras metrológicas (ISO 17025)**
    *   Ao selecionar **EquipamentoLaboratorio** num ensaio:
        *   apenas equipamentos com `EstadoMetrologico = Apto` e calibração válida aparecem.
    *   Mudança de estado para `Reprovado`/`ForaDeServico`:
        *   bloqueia novos ensaios com o equipamento;
        *   dispara avaliação de impacto em **ResultadoEnsaio** recentes.

Normas relevantes: **ISO 17025**, **ISO 9001**, **ISO 22000**.
* * *

## 2.5 Domínio FSMS (HACCP/BPF) + Equipamentos de Processo & CIPs

### 2.5.1 Plano HACCP e PCC

*   **PlanoHACCP** (por unidade/produto/linha) → vários **PCC**.
*   Cada **PCC** possui:
    *   parâmetros medidos;
    *   limites críticos e de alerta;
    *   ações corretivas;
    *   responsável.
*   **MonitorizacaoPCC**: registos com valor medido, dentro/fora de limite, utilizador, data/hora, referência a **LoteProducao** (quando aplicável).

### 2.5.2 Gestão de EquipamentoProcesso e Execução de CIPs

*   **EquipamentoProcesso**
    *   atributos de higiene: `EstadoHigiene` = `LiberadoUso`, `RequerCIP`, `EmCIP`, `BloqueadoPorCIPReprovado`;
    *   `DataHoraUltimoCIPConforme`, `ProgramaCIPUtilizado`.
*   **CircuitoCIP**: agrupamento lógico de equipamentos.
*   **PontoCIP / PontoHigiene**: nós críticos ligados a PCC e a Execução de CIP.
*   **ExecucaoCIP**:
    *   CircuitoCIPId, lista de EquipamentoProcesso envolvidos;
    *   Programa (etapas: pré‑enxague, cáustico, ácido, desinfecção, enxague final);
    *   parâmetros alvo e medidos (tempo, T, condutividade, fluxo, concentração);
    *   estados: `Planeado`, `EmExecucao`, `ConcluidoConforme`, `ConcluidoComAlerta`, `Abortado`.

### 2.5.3 Integração CIP ↔ LIMS ↔ QMS/MES

*   Amostras de **água de enxaguamento** e **swab de superfície** referencia **ExecucaoCIP** + **EquipamentoProcesso**.
*   Se **ExecucaoCIP** for reprovada (parâmetros fora de limite crítico ou resultados microbiológicos fora de especificação):
    *   gera **NaoConformidade** (origem "CIP");
    *   coloca `EstadoHigiene` de cada **EquipamentoProcesso** em `BloqueadoPorCIPReprovado`;
    *   impede associação do equipamento a novos **LoteProducao** até novo CIP conforme.

Normas relevantes: **ISO 22000**, **HACCP**, **BPF**.
* * *

## 2.6 Domínio QMS (NC, CAPA, Auditorias)

### 2.6.1 Entidades

*   **NaoConformidade**: origem (LIMS, PCC, CIP, fornecedor, auditoria), criticidade (menor, maior, crítica), estado.
*   **CAPA**: ações, responsáveis, prazos, estado.
*   **Auditoria**: tipo (interna, externa, fornecedor), achados, ligações a NC e CAPA.

### 2.6.2 Regras de negócio transversais

*   Fontes de **NaoConformidade**:
    *   **ResultadoEnsaio** fora de especificação;
    *   **MonitorizacaoPCC** fora de limite crítico;
    *   **ExecucaoCIP** reprovada;
    *   problemas metrológicos que invalidem ensaios;
    *   desvios em **InspecaoRecepcao** de matérias-primas.
*   Cada **NC** pode possuir várias **CAPA** com workflow próprio (Planeada → EmExecucao → EmVerificacaoEficacia → Encerrada).
*   Uma **NC** crítica ligada a lote **não permite** liberação até CAPA essenciais estarem pelo menos em estado `EmVerificacaoEficacia` (regra de negócio opcional, a detalhar por planta).

Normas relevantes: **ISO 9001**, **ISO 22000**, **ISO 17025**.
* * *

## 2.7 Motor de decisão de qualidade (liberação/bloqueio)

O motor de decisão é a peça lógica que consolida dados de **MES, LIMS, FSMS, QMS, CIP e Metrologia** para definir o estado de qualidade do lote.

### 2.7.1 Entradas principais

*   **LoteProducao** + sua árvore de relações:
    *   **ResultadoEnsaio** (ligados via Amostra/Laudo).
    *   **MonitorizacaoPCC**.
    *   **NC** abertas ligadas ao lote ou às matérias-primas.
    *   **ExecucaoCIP** e `EstadoHigiene` dos **EquipamentoProcesso** usados.
    *   Situação metrológica de **EquipamentoLaboratorio** usados em ensaios críticos.

### 2.7.2 Regras tipo (refinando BL‑01…BL‑04)

1. **Regra BL‑01 – Bloqueio por resultado crítico fora de especificação**
    *   Se existir **ResultadoEnsaio(conformidade = Reprovado)** com criticidade maior/crítica:
        *   `EstadoQualidade(LoteProducao)` → `Bloqueado`;
        *   abrir/ligar **NaoConformidade**;
        *   impedir transição para `Liberado`.
2. **Regra BL‑02 – Bloqueio por PCC fora de limite crítico**
    *   Se **MonitorizacaoPCC** com valor acima de limite crítico sem NC tratada:
        *   `EstadoQualidade(LoteProducao)` → `Bloqueado` ou `Segregado`;
        *   abrir **NC** origem "PCC";
        *   opcionalmente bloquear também ordens seguintes até CAPA.
3. **Regra BL‑03 – Bloqueio preventivo por ausência de análises obrigatórias**
    *   Se LoteProducao em `Concluida` e existirem **Amostra/ResultadoEnsaio** obrigatórios não concluídos/validados:
        *   `EstadoQualidade` mantém‑se `AguardandoLiberacaoQualidade`;
        *   não permitir expedição;
        *   emitir alerta para laboratório/qualidade.
4. **Regra BL‑04 – Liberação normal de lote**
    *   Condições cumulativas:
        *   todos **ResultadoEnsaio** críticos `ValidadoQualidade` e dentro de especificação;
        *   nenhuma **NC** crítica/maior aberta para lote ou matérias-primas usadas;
        *   nenhuma **MonitorizacaoPCC** crítica pendente sem CAPA;
        *   todos **EquipamentoProcesso** usados com `EstadoHigiene = LiberadoUso`;
        *   equipamentos laboratoriais usados com `EstadoMetrologico = Apto`.
    *   Saída:
        *   `EstadoQualidade(LoteProducao)` → `Liberado`;
        *   registar decisão em **AuditLog**.

Normas relevantes: **ISO 22000**, **HACCP**, **ISO 9001**, **ISO 17025**.
* * *

## 2.8 Domínio Materiais & Fornecedores

### 2.8.1 Entidades

*   **Fornecedor**
*   **MateriaPrima / MaterialEmbalagem**
*   **LoteMateriaPrima** (n.º lote fornecedor, COA, validade, estado de qualidade)
*   **InspecaoRecepcao**
*   **AvaliacaoFornecedor**

### 2.8.2 Regras funcionais

*   Estados de **LoteMateriaPrima**: `AguardandoInspecao`, `EmAnalise`, `Liberado`, `Bloqueado`, `Consumido`.
*   **InspecaoRecepcao** (inclui resultados LIMS quando aplicável) define transição `Liberado`/`Bloqueado`.
*   Histórico de rejeições/NC alimenta **AvaliacaoFornecedor** e relatórios.
*   **LoteMateriaPrima****`Bloqueado`** não pode ser associado a novos **LoteProducao**.

Normas relevantes: **ISO 9001**, **ISO 22000**, **BPF**.
* * *

## 2.9 Domínio Engenharia de Produto & Integração com Relatórios/Engenharia de Processo

### 2.9.1 Engenharia de Produto

*   **Produto**, **VersaoProduto**, **Receita**, **EspecificacaoProduto**, **ParametroControle**.
*   Regras:
    *   versionamento com datas de vigência;
    *   propagação automática de novos limites para **PlanoAmostragem**, **PCC** e critérios em **ResultadoEnsaio**.

### 2.9.2 Relatórios / BI / Engenharia de Processo

*   Cubos/dimensões lógicas (não físicas):
    *   Fatos: **LoteProducao**, **ResultadoEnsaio**, **MonitorizacaoPCC**, **NC**, **CAPA**, **ExecucaoCIP**, **LoteMateriaPrima**;
    *   Dimensões: **Tempo**, **LinhaProducao**, **Produto**, **Fornecedor**, **UnidadeIndustrial**.
*   Engenharia de Processo utiliza estas vistas para:
    *   estudos de capacidade (Cp/Cpk);
    *   correlações processo ↔ qualidade ↔ CIP ↔ NC;
    *   revisão de planos HACCP e planos de amostragem.

Normas relevantes: **ISO 9001** (melhoria contínua), **ISO 22000**.
* * *

## 2.10 Notas para o desenho físico de base de dados (entrada para TAI-AI)

> Esta secção não define o modelo físico, mas **orienta** o SmartLab TypeScript Architecture & Integration Agent (TAI-AI) na criação de esquema de tabelas e relações em Supabase.

1. **Limites de agregados / "bounded contexts" físicos sugeridos**
    *   Contexto **Produção/MES**: OrdemProducao, LoteProducao, EventoProducao, ConsumoLoteMateriaPrima, LinhaProducao, Turno, EquipamentoProcesso.
    *   Contexto **LIMS + Metrologia**: PlanoAmostragem, Amostra, EnsaioLaboratorial, ResultadoEnsaio, Laudo, EquipamentoLaboratorio, CertificadoCalibracao, IntervencaoManutencao.
    *   Contexto **QMS/FSMS**: PlanoHACCP, PCC, MonitorizacaoPCC, ChecklistBPF, NaoConformidade, CAPA, Auditoria.
    *   Contexto **Materiais & Fornecedores**: Fornecedor, MateriaPrima/MaterialEmbalagem, LoteMateriaPrima, InspecaoRecepcao, AvaliacaoFornecedor.
    *   Contexto **Engenharia de Produto**: Produto, VersaoProduto, Receita, EspecificacaoProduto, ParametroControle.
    *   Contexto **Segurança & Acesso**: Usuario, PerfilAcesso, Permissao, AuditLog.
2. **Chaves de integração fortes**
    *   `LoteProducaoId` como eixo de integração para MES ↔ LIMS ↔ QMS ↔ FSMS ↔ CIP ↔ BI.
    *   `LoteMateriaPrimaId` para rastreio fornecedor ↔ produção ↔ NC.
    *   `EquipamentoProcessoId` e `EquipamentoLaboratorioId` para CIP e metrologia.
    *   `PlanoHACCPId`, `PccId`, `PlanoAmostragemId` para vincular regras de controlo.
3. **Requisitos obrigatórios de auditabilidade**
    *   Todas as entidades críticas devem:
        *   suportar carimbo de criação/atualização (created\_at, updated\_at);
        *   ter referência a `Usuario` (quem fez o quê);
        *   registar alterações sensíveis em **AuditLog** (estado de lote, liberação/bloqueio, alteração de especificações, alterações em PlanoHACCP, etc.).
4. **Multitenancy**
    *   Garantir que todas as tabelas de domínio crítico possuem **TenantId** ou equivalente, isolando dados por organização/unidade.
* * *

**Próximos passos esperados**
> O TAI-AI deve, a partir desta página + "ERD Mental Global" + "System Foundation", propor:esquema físico de tabelas (Supabase) por contexto;chaves primárias/estrangeiras e tabelas de junção;padrões de naming, índices e colunas de estado.O SmartLab Product Orchestrator (CPO-AI) revisará o esquema proposto à luz deste ERD funcional e dos requisitos normativos/industriais, ajustando onde necessário.
* * *

## Módulo MES – User Stories Funcionais
### 1\. Planeador de Produção
*   **US-MES-01** – Como _Planeador de Produção_, quero criar **Ordens de Produção** por produto, unidade industrial e linha de produção, para conseguir planear volumes por período e por turno.
*   **US-MES-02** – Como _Planeador de Produção_, quero ver a **capacidade disponível** por linha/turno antes de confirmar uma Ordem de Produção, para evitar sobrecarga de capacidade.
*   **US-MES-03** – Como _Planeador de Produção_, quero que cada Ordem de Produção possa ser dividida em um ou mais **Lotes de Produção**, para conseguir ajustar tamanhos de lote ao contexto operacional e de qualidade.
### 2\. Supervisor de Produção
*   **US-MES-04** – Como _Supervisor de Produção_, quero **abrir um Lote de Produção** a partir de uma Ordem de Produção, selecionando linha, turno e equipamentos envolvidos, para iniciar formalmente a execução do lote.
*   **US-MES-05** – Como _Supervisor de Produção_, quero que, ao abrir um Lote de Produção, o sistema **crie automaticamente os ganchos** para **Plano de Amostragem (LIMS)** e **Plano HACCP/PCC (FSMS)** adequados ao produto e à linha, para garantir que os controlos de qualidade e segurança são disparados sem falhas.
*   **US-MES-06** – Como _Supervisor de Produção_, quero acompanhar em tempo real o **estado de execução do lote** (Planejado, Em Execução, Concluído) e o **estado de qualidade** (Aguardando Análises, Aguardando Liberação, Liberado, Bloqueado, Segregado), para saber se o lote pode avançar para expedição.
*   **US-MES-07** – Como _Supervisor de Produção_, quero **encerrar o lote** apenas quando todos os passos de processo obrigatórios estiverem concluídos, para impedir encerramentos prematuros que prejudiquem a rastreabilidade.
### 3\. Operador de Linha
*   **US-MES-08** – Como _Operador de Linha_, quero registar **Eventos de Produção** (início/fim de lote, paragens, sucata, reprocessos) diretamente ligados ao Lote de Produção, para garantir rastreabilidade operacional completa.
*   **US-MES-09** – Como _Operador de Linha_, quero registar o **consumo de lotes de matéria-prima** em cada Lote de Produção, para garantir que a rastreabilidade Lote Produto ↔ Lote Matéria-Prima fica fechada.
*   **US-MES-10** – Como _Operador de Linha_, quero ver claramente **quais equipamentos estão liberados ou bloqueados** por motivos de CIP ou manutenção, para não iniciar produção em equipamentos não conformes.
### 4\. Técnico de Qualidade (Integração LIMS/QMS/FSMS ↔ MES)
*   **US-MES-11** – Como _Técnico de Qualidade_, quero visualizar, a partir do Lote de Produção, todas as **Amostras, Ensaios Laboratoriais e Resultados de Ensaio** associados, para tomar decisões de liberação ou bloqueio de forma integrada.
*   **US-MES-12** – Como _Técnico de Qualidade_, quero que o sistema **impeça a liberação do lote** se existirem Resultados de Ensaio obrigatórios em falta, em estado provisório ou Reprovados sem tratamento, para garantir conformidade com especificação de produto.
*   **US-MES-13** – Como _Técnico de Qualidade_, quero que desvios em **Monitorização de PCC (FSMS)** e em **Execuções de CIP** sejam considerados automaticamente na decisão de liberação de lote, para que a qualidade do lote reflita também o estado de processo e de higiene.
*   **US-MES-14** – Como _Técnico de Qualidade_, quero poder **bloquear, segregar ou rejeitar** um Lote de Produção diretamente a partir do ecrã do lote, com geração automática de **Não Conformidade (NC)** e, quando aplicável, ligação a ações de CAPA.
### 5\. Engenheiro de Processo / FSMS
*   **US-MES-15** – Como _Engenheiro de Processo_, quero definir, para cada combinação **Produto + Linha + PCC**, quais **parâmetros críticos de processo** e **limites de controlo** devem ser monitorizados, para que o MES recolha e disponibilize os dados certos ao FSMS.
*   **US-MES-16** – Como _Responsável FSMS/HACCP_, quero que o sistema mantenha a ligação entre **Lote de Produção, PCC monitorizados e Execuções de CIP** relevantes, para poder reconstruir o histórico de risco de cada lote em auditorias.
### 6\. Gestão de Equipamentos de Processo e CIPs
*   **US-MES-17** – Como _Supervisor de Manutenção/Produção_, quero que cada **Execução de CIP** seja registada como uma entidade rastreável, ligada a Circuitos e Equipamentos de Processo, para garantir prova de limpeza adequada.
*   **US-MES-18** – Como _Supervisor de Produção_, quero que o MES **bloqueie automaticamente a atribuição de equipamentos** a novos lotes quando o estado de higiene estiver em `RequerCIP` ou `BloqueadoPorCIPReprovado`, para evitar uso indevido.
### 7\. Relato Operacional e Rastreabilidade
*   **US-MES-19** – Como _Gestor de Fábrica_, quero consultar **relatórios de desempenho por linha, turno e produto**, cruzando estados de lote, paragens, sucata e decisões de qualidade, para identificar gargalos e oportunidades de melhoria.
*   **US-MES-20** – Como _Responsável de Qualidade/FSMS_, quero gerar relatórios de **rastreabilidade completa do lote** (Lote de Produção, Matérias-Primas, Equipamentos, CIPs, Amostras, Resultados, NCs), para responder rapidamente a reclamações de cliente e auditorias.
* * *

## Módulo MES – ERD Funcional e Intervenientes
### 1\. Entidades principais do MES
*   **unidade\_industrial** – identifica a fábrica / site.
*   **linha\_producao** – representa linhas ou células de produção (FK para unidade\_industrial).
*   **produto** – catálogo de produtos finais e, quando aplicável, semiacabados.
    *   **ordem\_producao**Liga produto, linha\_producao e período planeado.
    *   Campos chave: quantidade\_planeada, datas planeadas, status\_execucao.
    *   **lote\_producao**Unidade central de rastreio no MES.
    *   FKs: ordem\_producao\_id, produto\_id, linha\_producao\_id, turno\_id.
    *   Campos de estado: status\_execucao (Planejado, EmExecucao, Concluido), status\_qualidade (AguardandoAnalises, AguardandoLiberacaoQualidade, Liberado, Bloqueado, Segregado, Descartado), motivo\_bloqueio.
    *   **evento\_producao**Regista eventos relevantes (início/fim de lote, paragens, sucata, reprocesso, mudança de produto).
    *   FK: lote\_producao\_id, equipamento\_processo\_id (opcional).
*   **lote\_materia\_prima** – Representa lotes recebidos de matérias-primas/embalagens, com origem e estado próprio de qualidade.
*   **lote\_producao\_materia\_prima** – Tabela de junção N:N entre lote\_producao e lote\_materia\_prima, com campos de quantidade consumida por evento/etapa.
*   **lote\_producao\_equipamento** – Liga lote\_producao aos equipamentos efetivamente utilizados durante o lote.
### 2\. Intervenientes chave conectados ao MES
*   **equipamento\_processo** (FSMS/MES)
    *   Tanques, enchedoras, pasteurizadores, tubagens, etc.
    *   Campos de estado de higiene: estado\_higiene (LiberadoUso, RequerCIP, EmCIP, BloqueadoPorCIPReprovado), data\_ultimo\_cip\_conforme.
*   **circuito\_cip** e **execucao\_cip** (FSMS)
    *   Circuitos de limpeza que agrupam equipamentos.
    *   execucao\_cip referencia circuito\_cip e N equipamento\_processo; contém parâmetros de processo de limpeza.
*   **plano\_amostragem**, **amostra**, **ensaio\_laboratorial**, **resultado\_ensaio**, **laudo\_lote** (LIMS)
    *   amostra tem FK opcional para lote\_producao\_id (ou execucao\_cip\_id, para amostras de CIP).
    *   laudo\_lote referencia lote\_producao\_id.
*   **plano\_haccp**, **pcc**, **monitorizacao\_pcc** (FSMS)
    *   monitorizacao\_pcc referencia lote\_producao (quando aplicável) e/ou linha\_producao + timestamp.
*   **nao\_conformidade** e **acao\_capa** (QMS)
    *   podem referenciar lote\_producao, lote\_materia\_prima, execucao\_cip, resultado\_ensaio ou monitorizacao\_pcc.
### 3\. Relações funcionais críticas
*       *   **Produção ↔ LIMS**`lote_producao.id` é chave de integração central com amostra, resultado\_ensaio e laudo\_lote.
    *   A abertura de lote\_producao instancia ganchos para plano\_amostragem; a conclusão depende do estado dos resultados e laudos.
    *   **Produção ↔ FSMS (HACCP + CIP)**lote\_producao utiliza equipamentos ligados a equipamento\_processo; o seu estado\_higiene é validado antes de iniciar novo lote.
    *   monitorizacao\_pcc, associada a plano\_haccp/pcc, pode gerar NC e bloquear lote\_producao.
    *   execucao\_cip condiciona estado\_higiene do equipamento\_processo e, indiretamente, a elegibilidade do equipamento para novos lotes.
    *   **Produção ↔ QMS**nao\_conformidade e acao\_capa referenciam lotes, matérias-primas, resultados e execuções de CIP, permitindo reconstruir o racional de qualquer decisão de bloqueio/liberação.
### 4\. Regras de negócio ancoradas no ERD MES
*   Um **Lote de Produção** só pode transitar para estado de qualidade **Liberado** quando:
    *   existir pelo menos um **Laudo de Lote** válido associado;
    *   todos os **Resultados de Ensaio obrigatórios** estiverem em estado ValidadoQualidade e conformes com a Especificação de Produto;
    *   não existirem **Monitorizações de PCC** críticas não tratadas ligadas ao lote;
    *   todos os **Equipamentos de Processo** usados estiverem em estado\_higiene = LiberadoUso e com última Execução de CIP conforme dentro da janela máxima configurada;
    *   não existirem **NC críticas abertas** relacionadas ao lote ou às matérias-primas consumidas.
*   O ERD funcional do MES garante que todos estes checks podem ser implementados via joins e queries explícitas, suportando tanto a automação da decisão como a rastreabilidade para auditoria.